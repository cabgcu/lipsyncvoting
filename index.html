<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Lip Sync 2025 Online Voting</title>

<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- FingerprintJS -->
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs/dist/fp.min.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";

/* ========= Firebase Config ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBoYf1_IhILJ96Y9KMcwrVjHMFLT5YEKuQ",
  authDomain: "lip-sync-2025.firebaseapp.com",
  projectId: "lip-sync-2025",
  storageBucket: "lip-sync-2025.firebasestorage.app",
  messagingSenderId: "118581305479",
  appId: "1:118581305479:web:7a7335c1be6e816cc7d822",
  measurementId: "G-NQ0GMG05Q2"
};

/* ========= Globals ========= */
let db, auth, userId, visitorId = null;
let selectedVoteId = null;
let selectedVoteName = "";
let selectedVoteImage = "";
let appInitialized = false;
let votingEnabled = true;

/* ========= Performers ========= */
const performerData = {
  option1: { name: "Below", img: "https://i.imgur.com/DIyK2zX.jpeg" },
  option2: { name: "Deliverance", img: "https://i.imgur.com/s7Unz9r.jpeg" },
  option3: { name: "Mask Off", img: "https://i.imgur.com/x0BI8Mc.jpeg" },
  option4: { name: "Metro Motion", img: "https://i.imgur.com/4rG47gL.jpeg" },
  option5: { name: "Sin Game", img: "https://i.imgur.com/k75mMUz.jpeg" },
  option6: { name: "Anonymity", img: "https://i.imgur.com/3dJQFeX.jpeg" },
};

/* ========= DOM Elements ========= */
let performersContainer, submitVoteButton, confirmationMessage, confirmationImage;

/* ========= Init ========= */
document.addEventListener("DOMContentLoaded", async () => {
  performersContainer = document.getElementById("performers-container");
  submitVoteButton = document.getElementById("submit-vote-btn");
  confirmationMessage = document.getElementById("confirmation-message");
  confirmationImage = document.getElementById("confirmation-image");

  const app = initializeApp(firebaseConfig);
  initializeAppCheck(app, {
    provider: new ReCaptchaV3Provider('6LdIDf8rAAAAAN29EDUYVkddlpw3QQy9ImSPFpm1'),
    isTokenAutoRefreshEnabled: true
  });
  db = getFirestore(app);
  auth = getAuth(app);

  initializeAppLogic();
});

/* ========= Helper Functions ========= */
function setScreen(id) {
  document.querySelectorAll(".screen").forEach(el => el.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

function showError(msg) {
  const el = document.getElementById("vote-error");
  el.textContent = msg;
  el.classList.add("text-red-400", "font-bold");
}

/* ========= Restore Vote ========= */
async function restoreVoteIfExists() {
  if (!userId || !db) return;
  const snap = await getDoc(doc(db, "lip_sync_2025_votes", userId));
  if (snap.exists()) {
    const performer = performerData[snap.data().voteId];
    confirmationImage.src = performer.img;
    confirmationMessage.innerHTML = `
      Your vote for <b>${performer.name}</b> has been recorded.<br><br>
      Thank you for watching <b>Lip Sync: For Good!</b>
    `;
    setScreen("confirmation-screen");
  } else {
    setScreen("voting-screen");
  }
}

/* ========= Card Selection ========= */
function handleCardSelection(e) {
  const card = e.target.closest(".performer-card");
  if (!card || !votingEnabled) return;
  document.querySelectorAll(".performer-card").forEach(c => c.classList.remove("selected"));
  card.classList.add("selected");
  selectedVoteId = card.dataset.voteId;
  selectedVoteName = card.querySelector("h4").textContent;
  selectedVoteImage = card.querySelector("img").src;
  submitVoteButton.disabled = false;
  submitVoteButton.textContent = `Submit Vote for ${selectedVoteName}`;
  submitVoteButton.classList.add("ready");
}

/* ========= Submit Vote ========= */
async function submitVote(voteId, btn) {
  if (!visitorId) return showError("Fingerprint not ready.");
  if (!votingEnabled) return showError("Voting is currently closed.");
  if (!userId) return showError("User not authenticated.");

  btn.disabled = true;
  btn.textContent = "Submitting...";

  try {
    const voteRef = doc(db, "lip_sync_2025_votes", userId);
    const voteData = {
      voteId,
      createdAt: Date.now(),
      userId,
      fingerprint: visitorId,
      voteSource: "online",
      userAgent: navigator.userAgent
    };
    await setDoc(voteRef, voteData);

    confirmationImage.src = selectedVoteImage;
    confirmationMessage.innerHTML = `
      Your vote for <b>${selectedVoteName}</b> has been recorded.<br><br>
      Thank you for watching <b>Lip Sync: For Good!</b>
    `;
    setScreen("confirmation-screen");
  } catch (e) {
    btn.disabled = false;
    btn.textContent = "Vote Failed – Retry";
    showError("Error saving vote: " + e.message);
  }
}

/* ========= Main App Logic ========= */
function initializeAppLogic() {
  if (appInitialized) return;
  appInitialized = true;

  FingerprintJS.load().then(fp => fp.get()).then(r => {
    visitorId = r.visitorId;
  });

  performersContainer.addEventListener("click", handleCardSelection);
  submitVoteButton.addEventListener("click", () => submitVote(selectedVoteId, submitVoteButton));

  const settingsRef = doc(db, "lip_sync_2025_settings", "state");
  onSnapshot(settingsRef, (snap) => { if (snap.exists()) votingEnabled = snap.data().enabled; });

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      userId = user.uid;
      const ref = doc(db, "lip_sync_2025_votes", userId);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        console.log("Old UID already voted, refreshing anonymous session...");
        await signOut(auth);
        await new Promise(r => setTimeout(r, 1000));
        await signInAnonymously(auth);
        return;
      }
      await restoreVoteIfExists();
    } else {
      await signInAnonymously(auth).catch(err => showError("Could not connect: " + err.message));
    }
  });
}
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
html, body { margin:0; height:100%; font-family:'Inter',sans-serif; color:white; overflow:hidden; background:black; }
#bg-video { position:fixed; top:0; left:0; width:100vw; height:100vh; object-fit:cover; z-index:0; opacity:0.8; }
.glass-card { background:rgba(0,0,0,0.45); backdrop-filter:blur(24px); border-radius:1.5rem; border:1px solid rgba(255,255,255,0.15); }
.performer-card.selected { border:2px solid #22c55e; box-shadow:0 0 20px 3px rgba(34,197,94,0.5); }
#submit-vote-btn.ready { background:#22c55e !important; color:black !important; border:none !important; box-shadow:0 0 12px 2px rgba(34,197,94,0.6); transition:all .3s ease; }
</style>
</head>

<body>
<video autoplay muted playsinline loop preload="auto" id="bg-video" src="https://i.imgur.com/mAzP2S1.mp4"></video>

<!-- VOTING SCREEN -->
<div id="voting-screen" class="screen flex items-center justify-center p-4">
  <div class="glass-card p-6 w-11/12 max-w-md text-center">
    <img src="https://i.imgur.com/EnuWGLA.png" class="w-full max-w-[200px] mx-auto mb-4">
    <p class="text-white/70 mb-4">Each person may vote only once per device.</p>
    <p id="vote-error" class="text-sm text-white/70 mb-4"></p>
    <div id="performers-container" class="space-y-3 overflow-y-auto" style="max-height:60vh;">
      ${Object.entries({
        option1:"Below",
        option2:"Deliverance",
        option3:"Mask Off",
        option4:"Metro Motion",
        option5:"Sin Game",
        option6:"Anonymity"
      }).map(([id,name])=>`
      <div class="performer-card bg-white/5 border border-white/10 p-3 rounded-xl cursor-pointer" data-vote-id="${id}">
        <img src="${performerData[id].img}" class="w-full aspect-video object-cover rounded-lg mb-2">
        <h4 class="text-lg font-semibold">${name}</h4>
      </div>`).join("")}
    </div>
    <button id="submit-vote-btn" class="mt-6 w-full py-3 bg-black border border-white/50 text-white rounded-xl" disabled>Select a Performer to Vote</button>
  </div>
</div>

<!-- CONFIRMATION -->
<div id="confirmation-screen" class="screen hidden flex items-center justify-center p-4">
  <div class="glass-card p-8 w-11/12 max-w-md text-center">
    <h3 class="text-3xl font-bold mb-4 text-white">✅ Submission Received!</h3>
    <img id="confirmation-image" class="w-full max-w-[240px] mx-auto rounded-xl mb-6" alt="Team Image">
    <p id="confirmation-message" class="text-white text-base mb-6"></p>
  </div>
</div>
</body>
</html>
